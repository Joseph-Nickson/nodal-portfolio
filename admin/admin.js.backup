const API_URL = 'http://localhost:3001';
let allWorks = [];
let currentEditWork = null;

async function loadWorks() {
    try {
        const response = await fetch(API_URL + '/works');
        allWorks = await response.json();
        renderWorks();
        updateStats();
        populateFilters();
    } catch (error) {
        showStatus('Error loading works', 'error');
    }
}

function renderWorks() {
    const tbody = document.getElementById('worksBody');
    const search = document.getElementById('searchInput').value.toLowerCase();
    const yearFilter = document.getElementById('yearFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;

    let filtered = allWorks.filter(work => {
        const matchSearch = !search || 
            work.title.toLowerCase().includes(search) ||
            work.client.toLowerCase().includes(search) ||
            work.contribution.toLowerCase().includes(search);
        const matchYear = !yearFilter || work.date === yearFilter;
        const matchType = !typeFilter || work.type === typeFilter;
        return matchSearch && matchYear && matchType;
    });

    tbody.innerHTML = filtered.map(work => {
        const imagePath = work.image || work.thumbnail || '';
        return `
            <tr>
                <td><div class="preview">${imagePath ? `<img src="../${imagePath}" alt="${work.title}">` : ''}</div></td>
                <td><strong>${work.title}</strong></td>
                <td>${work.date}</td>
                <td>${work.client}</td>
                <td>${work.contribution}</td>
                <td>${work.style}</td>
                <td>${work.featured ? '‚≠ê' : ''}</td>
                <td>
                    <button class="btn-icon" onclick="editWork('${work.id}')" title="Edit">Edit</button>
                    <button class="btn-icon" onclick="deleteWork('${work.id}', '${work.title}')" title="Delete">Delete</button>
                </td>
            </tr>
        `;
    }).join('');
}

function updateStats() {
    document.getElementById('totalWorks').textContent = allWorks.length;
    document.getElementById('featuredWorks').textContent = allWorks.filter(w => w.featured).length;
}

function populateFilters() {
    const years = [...new Set(allWorks.map(w => w.date))].sort().reverse();
    const yearFilter = document.getElementById('yearFilter');
    yearFilter.innerHTML = '<option value="">All Years</option>' + 
        years.map(y => `<option value="${y}">${y}</option>`).join('');
}

function openModal(work = null) {
    currentEditWork = work;
    const modal = document.getElementById('modal');
    const form = document.getElementById('workForm');
    
    document.getElementById('modalTitle').textContent = work ? 'Edit Work' : 'Add New Work';
    
    if (work) {
        form.title.value = work.title;
        form.date.value = work.date;
        form.client.value = work.client;
        form.contribution.value = work.contribution;
        form.style.value = work.style;
        form.type.value = work.type;
        form.featured.checked = work.featured;
        form.videoId.value = work.videoId || '';
        form.image.required = false;
    } else {
        form.reset();
        form.image.required = true;
    }
    
    toggleVideoIdField(form.type.value);
    modal.classList.add('active');
}

function closeModal() {
    document.getElementById('modal').classList.remove('active');
    currentEditWork = null;
}

function toggleVideoIdField(type) {
    const videoIdGroup = document.getElementById('videoIdGroup');
    videoIdGroup.style.display = type === 'video' ? 'block' : 'none';
}

async function saveWork(formData) {
    try {
        const url = currentEditWork ? `${API_URL}/works/${currentEditWork.id}` : `${API_URL}/works`;
        const method = currentEditWork ? 'PUT' : 'POST';
        const response = await fetch(url, { method, body: formData });
        if (!response.ok) throw new Error('Failed to save work');
        showStatus(currentEditWork ? 'Work updated!' : 'Work added!', 'success');
        closeModal();
        loadWorks();
    } catch (error) {
        showStatus('Error saving work', 'error');
    }
}

async function editWork(id) {
    const work = allWorks.find(w => w.id == id);
    if (work) openModal(work);
}

async function deleteWork(id, title) {
    if (!confirm(`Delete "${title}"?`)) return;
    try {
        const response = await fetch(`${API_URL}/works/${id}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Failed');
        showStatus('Work deleted', 'success');
        loadWorks();
    } catch (error) {
        showStatus('Error deleting work', 'error');
    }
}

async function buildData() {
    const btn = document.getElementById('buildBtn');
    btn.disabled = true;
    btn.textContent = 'Building...';
    try {
        const response = await fetch(`${API_URL}/build`, { method: 'POST' });
        const result = await response.json();
        if (!response.ok) throw new Error(result.error);
        showStatus(`Built ${result.count} works!`, 'success');
        document.getElementById('lastBuild').textContent = new Date().toLocaleTimeString();
    } catch (error) {
        showStatus('Build error', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Build & Deploy';
    }
}

function showStatus(message, type) {
    const status = document.getElementById('buildStatus');
    status.textContent = message;
    status.className = 'build-status ' + type + ' show';
    setTimeout(() => status.classList.remove('show'), 3000);
}

document.addEventListener('DOMContentLoaded', () => {
    loadWorks();
    document.getElementById('addWorkBtn').onclick = () => openModal();
    document.getElementById('buildBtn').onclick = buildData;
    document.querySelector('.modal-close').onclick = closeModal;
    document.getElementById('cancelBtn').onclick = closeModal;
    document.getElementById('searchInput').oninput = renderWorks;
    document.getElementById('yearFilter').onchange = renderWorks;
    document.getElementById('typeFilter').onchange = renderWorks;
    document.querySelector('[name="type"]').onchange = (e) => toggleVideoIdField(e.target.value);
    document.getElementById('workForm').onsubmit = async (e) => {
        e.preventDefault();
        await saveWork(new FormData(e.target));
    };
    document.getElementById('modal').onclick = (e) => {
        if (e.target.id === 'modal') closeModal();
    };
});
