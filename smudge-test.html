<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mixer Brush - Photoshop Style</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 0.05em;
            color: #1a1a1a;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        button {
            padding: 12px 24px;
            border: 3px solid #1a1a1a;
            border-radius: 8px;
            background: #ff6b35;
            color: white;
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: transform 0.1s ease;
        }

        button:hover {
            transform: scale(1.02);
        }

        button:active {
            transform: scale(0.98);
        }

        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .slider-group label {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        input[type="range"] {
            width: 150px;
        }

        .canvas-container {
            background: white;
            padding: 20px;
            border: 3px solid #1a1a1a;
            border-radius: 12px;
            position: relative;
        }

        canvas {
            display: block;
            cursor: crosshair;
        }

        .info {
            font-size: 11px;
            color: #666;
            max-width: 700px;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>MIXER BRUSH - PHOTOSHOP STYLE</h1>

    <div class="info">
        Click and drag to smudge. The brush picks up actual pixels and drags them around like real paint!
    </div>

    <div class="controls">
        <button id="reset-btn">RESET</button>

        <div class="slider-group">
            <label for="brush-size">BRUSH SIZE: <span id="size-val">50</span>px</label>
            <input type="range" id="brush-size" min="20" max="150" value="50">
        </div>

        <div class="slider-group">
            <label for="wetness">WETNESS: <span id="wetness-val">50</span>%</label>
            <input type="range" id="wetness" min="0" max="100" value="50">
        </div>

        <div class="slider-group">
            <label for="flow">FLOW: <span id="flow-val">50</span>%</label>
            <input type="range" id="flow" min="10" max="100" value="50">
        </div>
    </div>

    <div class="canvas-container" id="canvas-container">
        <canvas id="canvas"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const resetBtn = document.getElementById('reset-btn');
        const brushSizeSlider = document.getElementById('brush-size');
        const wetnessSlider = document.getElementById('wetness');
        const flowSlider = document.getElementById('flow');
        const sizeVal = document.getElementById('size-val');
        const wetnessVal = document.getElementById('wetness-val');
        const flowVal = document.getElementById('flow-val');

        const imagePath = "works/painting/F-aFtHJawAAlxP8.jpeg";
        const MAX_WIDTH = 700;
        const MAX_HEIGHT = 450;

        let originalImage = null;
        let isSmudging = false;
        let lastX = 0;
        let lastY = 0;
        let brushSize = 50;
        let wetness = 0.5; // How much paint to pick up vs keep
        let flow = 0.5; // How much to apply

        // The "paint on the brush" - this is what makes it feel like real paint
        let brushPaint = null;

        // Update sliders
        brushSizeSlider.addEventListener('input', (e) => {
            brushSize = parseInt(e.target.value);
            sizeVal.textContent = brushSize;
        });

        wetnessSlider.addEventListener('input', (e) => {
            wetness = parseInt(e.target.value) / 100;
            wetnessVal.textContent = e.target.value;
        });

        flowSlider.addEventListener('input', (e) => {
            flow = parseInt(e.target.value) / 100;
            flowVal.textContent = e.target.value;
        });

        // Load image
        const img = new Image();
        img.onload = function() {
            originalImage = img;

            // Scale to fit
            const scale = Math.min(MAX_WIDTH / img.width, MAX_HEIGHT / img.height, 1);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;

            // Draw initial image
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            console.log('Canvas ready:', canvas.width, 'x', canvas.height);
        };
        img.src = imagePath;

        // Reset button
        resetBtn.addEventListener('click', () => {
            if (originalImage) {
                ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
                brushPaint = null; // Clear brush
            }
        });

        // Mouse events
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            isSmudging = true;
            lastX = x;
            lastY = y;

            // Pick up paint from canvas (sample circular region)
            pickupPaint(x, y, brushSize);

            // Apply paint at starting position
            applyPaint(x, y, brushSize);
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isSmudging) return;

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // Interpolate between last position and current
            const dist = Math.sqrt((x - lastX) ** 2 + (y - lastY) ** 2);
            const steps = Math.max(1, Math.ceil(dist / 2)); // Smooth steps

            for (let i = 1; i <= steps; i++) {
                const t = i / steps;
                const ix = lastX + (x - lastX) * t;
                const iy = lastY + (y - lastY) * t;

                // Mix: pick up new paint + keep old paint (wetness control)
                mixPaint(ix, iy, brushSize, wetness);

                // Apply the mixed paint
                applyPaint(ix, iy, brushSize);
            }

            lastX = x;
            lastY = y;
        });

        canvas.addEventListener('mouseup', () => {
            isSmudging = false;
        });

        canvas.addEventListener('mouseleave', () => {
            isSmudging = false;
        });

        /**
         * Pick up paint from the canvas into the brush
         */
        function pickupPaint(x, y, size) {
            const radius = size / 2;
            const diameter = Math.ceil(size);

            // Get circular region of pixels
            const imageData = ctx.getImageData(
                Math.max(0, Math.floor(x - radius)),
                Math.max(0, Math.floor(y - radius)),
                Math.min(canvas.width, diameter),
                Math.min(canvas.height, diameter)
            );

            // Store as our brush paint
            brushPaint = {
                data: new Uint8ClampedArray(imageData.data),
                width: imageData.width,
                height: imageData.height,
                centerX: radius,
                centerY: radius
            };
        }

        /**
         * Mix new paint from canvas with existing brush paint
         */
        function mixPaint(x, y, size, mixAmount) {
            if (!brushPaint) {
                pickupPaint(x, y, size);
                return;
            }

            const radius = size / 2;
            const diameter = Math.ceil(size);

            // Get new paint from canvas
            const newPaint = ctx.getImageData(
                Math.max(0, Math.floor(x - radius)),
                Math.max(0, Math.floor(y - radius)),
                Math.min(canvas.width, diameter),
                Math.min(canvas.height, diameter)
            );

            // Mix with existing brush paint
            // mixAmount = 0: keep 100% old paint (dry brush)
            // mixAmount = 1: pick up 100% new paint (wet brush)
            for (let i = 0; i < brushPaint.data.length; i += 4) {
                if (i < newPaint.data.length) {
                    brushPaint.data[i] = brushPaint.data[i] * (1 - mixAmount) + newPaint.data[i] * mixAmount; // R
                    brushPaint.data[i + 1] = brushPaint.data[i + 1] * (1 - mixAmount) + newPaint.data[i + 1] * mixAmount; // G
                    brushPaint.data[i + 2] = brushPaint.data[i + 2] * (1 - mixAmount) + newPaint.data[i + 2] * mixAmount; // B
                    // Keep alpha at 255
                }
            }
        }

        /**
         * Apply brush paint to canvas with soft circular falloff
         */
        function applyPaint(x, y, size) {
            if (!brushPaint) return;

            const radius = size / 2;
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = brushPaint.width;
            tempCanvas.height = brushPaint.height;

            // Put our brush paint data onto temp canvas
            const imageData = tempCtx.createImageData(brushPaint.width, brushPaint.height);
            imageData.data.set(brushPaint.data);
            tempCtx.putImageData(imageData, 0, 0);

            // Create circular mask with soft edges
            const maskCanvas = document.createElement('canvas');
            const maskCtx = maskCanvas.getContext('2d');
            maskCanvas.width = brushPaint.width;
            maskCanvas.height = brushPaint.height;

            // Create radial gradient for soft circular brush
            const gradient = maskCtx.createRadialGradient(
                brushPaint.centerX, brushPaint.centerY, 0,
                brushPaint.centerX, brushPaint.centerY, radius
            );
            gradient.addColorStop(0, `rgba(255, 255, 255, ${flow})`);
            gradient.addColorStop(0.7, `rgba(255, 255, 255, ${flow * 0.5})`);
            gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');

            maskCtx.fillStyle = gradient;
            maskCtx.fillRect(0, 0, maskCanvas.width, maskCanvas.height);

            // Apply mask to paint using composite operation
            tempCtx.globalCompositeOperation = 'destination-in';
            tempCtx.drawImage(maskCanvas, 0, 0);

            // Draw the masked paint onto main canvas
            ctx.globalCompositeOperation = 'source-over';
            ctx.drawImage(
                tempCanvas,
                Math.floor(x - brushPaint.centerX),
                Math.floor(y - brushPaint.centerY)
            );
        }
    </script>
</body>
</html>
